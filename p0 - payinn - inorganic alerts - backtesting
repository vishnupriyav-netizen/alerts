-- 3 final ; to be set for alert 
with top_combinations as (
select
charge_currency,provider,payment_method_name,
countDistinct(case when payment_attempt_id is not null then payin_id end) as total_attempts,
round(count(distinct case when payment_attempt_status = 'succeeded' then payin_id else null end) * 1.0 / 
nullif(count(distinct case when payment_attempt_id <> '' then payin_id else null end), 0), 3) as sr
from payin
where payin_created_at >= now() - interval 30 day and payment_attempt_id <> ''
-- where payin_created_at >= '2025-09-08' - interval 10 day and payment_attempt_id <> ''
group by charge_currency, provider, payment_method_name
order by total_attempts desc
limit 20
), 

historical_traffic as (
select
a.charge_currency,
a.provider,
a.payment_method_name,
toDate(b.payin_created_at) as date,
toHour(b.payin_created_at) as hour,
intDiv(toMinute(b.payin_created_at), 30) as half_hour,
countDistinct(case when payment_attempt_id <> '' then b.payin_id end) as attempts,

round(count(distinct case when payment_attempt_status = 'succeeded' then payin_id else null end) * 1.0 / 
    nullif(count(distinct case when payment_attempt_id <> '' then payin_id else null end), 0), 3) as sr,


round(count(distinct case when payment_attempt_status = 'failed' then payin_id else null end) * 1.0 / 
    nullif(count(distinct case when b.payment_attempt_id <> '' then payin_id else null end), 0), 3) as fr,
    


round(count(distinct case when payment_attempt_status = 'failed' and error_code >= 14000
        AND error_code < 16000 then payin_id else null end) * 1.0 / 
    nullif(count(distinct case when b.payment_attempt_id <> '' then payin_id else null end), 0), 5) as inorganic_fr
    
from top_combinations a
left join payin b on 
a.charge_currency = b.charge_currency
and a.provider = b.provider
and a.payment_method_name = b.payment_method_name
and b.payin_created_at >= now() - interval 30 day
-- and b.payin_created_at >= toDate('2025-09-08') - interval 10 day
group by a.charge_currency, a.provider, a.payment_method_name, date, hour, half_hour
)

select * from historical_traffic

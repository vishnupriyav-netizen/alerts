-- sr dip 
-- top currency 
with top_currency as (
select charge_currency as top_currency, payment_method_name as method, provider, account_id, business_name, 
countDistinct(case when payment_attempt_id <> '' then payin_id end) as traffic
from payin 
where date(payin_created_at) >= '2025-08-10' and date(payin_created_at) < '2025-09-10'
and payment_attempt_id <> ''
group by 1,2,3,4,5
order by traffic desc limit 10
),

current_sr as (
select a.top_currency, a.method, a.provider, a.account_id, a.business_name, 
toDate(b.payin_created_at) as current_date, 
toHour(b.payin_created_at) as current_hour,
floor(toMinute(b.payin_created_at)/30) as current_half_hour,
countDistinct(case when b.payment_attempt_id is not null then payin_id end) as current_traffic,

round(count(distinct case when payment_attempt_status = 'succeeded' then payin_id else null end) * 1.0 / 
nullif(count(distinct case when payment_attempt_id <> ''  then payin_id else null end), 0), 3) as sr,

round(count(distinct case when payment_attempt_status = 'failed' then payin_id else null end) * 1.0 / 
    nullif(count(distinct case when payment_attempt_id <> ''  then payin_id else null end), 0), 3) as fr,
    
round(count(distinct case when payment_attempt_status = 'failed' AND error_code >= 14000
        AND error_code < 16000 then payin_id else null end) * 1.0 / 
    nullif(count(distinct case when payment_attempt_id <> ''  then payin_id else null end), 0), 3) as inorganic_fr
        
from top_currency a 
join payin b on a.top_currency = b.charge_currency and a.method = b.payment_method_name and a.provider = b.provider
and date(b.payin_created_at) >= '2025-08-20' and date(payin_created_at) < '2025-09-10'
group by 1,2,3,4,5,6, 7,8
),

historic_sr as (
select a.top_currency, a.method, a.provider, a.account_id, a.business_name, 
toDate(b.payin_created_at) as historic_date, 
toHour(b.payin_created_at) as hour,
floor(toMinute(b.payin_created_at)/30) as half_hour,
countDistinct(case when b.payment_attempt_id is not null then payin_id end) as historic_traffic,


round(count(distinct case when payment_attempt_status = 'failed' AND error_code >= 14000
        AND error_code < 16000 then payin_id else null end) * 1.0 / 
    nullif(count(distinct case when payment_attempt_id <> ''  then payin_id else null end), 0), 3) as historic_inorganic_fr
    
from top_currency a 
join payin b on a.top_currency = b.charge_currency and a.method = b.payment_method_name and a.provider = b.provider
and date(b.payin_created_at) >= '2025-08-10' and date(payin_created_at) < '2025-09-10'
group by 1,2,3,4,5,6,7,8
),

final as (
select a.*, 
    quantile(0.5)(b.historic_inorganic_fr) AS inorganic_median,
    stddevPop(b.historic_inorganic_fr) AS inorganic_stddev,
    count(b.historic_traffic) AS historical_data_points

from current_sr a 
left join historic_sr b on 
a.top_currency = b.top_currency and a.method = b.method and a.provider = b.provider and 
a.current_hour = b.hour and a.current_half_hour = b.half_hour and 
b.historic_date between a.current_date - 10 AND a.current_date - 1

group by 1,2,3,4,5,6,7,8,9,10,11,12)

select *
from final 
